<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Verification Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .step { display: none; }
        .step.active { display: block; }
        [contenteditable]:focus { outline: 2px solid #3b82f6; background-color: #eff6ff; }
        .mascot-container {
            position: absolute;
            bottom: 0;
            right: -2rem;
            width: 150px;
            height: 250px;
            display: none;
        }
        @media (min-width: 1024px) {
            .mascot-container {
                display: block;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-5xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold tracking-tight text-slate-800">Business Verification & Prospecting</h1>
                <p class="text-slate-600 mt-2">The secure, reliable tool for verifying and finding new customers.</p>
            </header>

            <main id="app-container" class="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-slate-200 min-h-[400px] relative">
                <!-- SVG Mascot Definitions -->
                <svg width="0" height="0" style="position:absolute">
                  <defs>
                    <g id="detective-base" fill="none" stroke="#475569" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M75,50 a25,25 0 1,1 -50,0 a25,25 0 1,1 50,0"/>
                      <path d="M20,30 Q50,10 80,30 M25,50 Q0,70 25,90 M75,50 Q100,70 75,90"/>
                      <path d="M50,75 V150 L30,220 H70 L50,150"/>
                      <circle cx="40" cy="45" r="2"/><circle cx="60" cy="45" r="2"/>
                    </g>
                  </defs>
                </svg>

                <!-- Step 1: File Upload -->
                <div id="step-upload" class="step active">
                    <div class="grid grid-cols-1 lg:grid-cols-3">
                        <div class="lg:col-span-2">
                            <div class="text-center lg:text-left">
                                <h2 class="text-2xl font-semibold text-slate-800">Step 1: Upload Your List</h2>
                                <p class="text-slate-500 mt-1">Select or drag a CSV or Excel file to get started.</p>
                            </div>
                            <div id="dropzone" class="mt-8 p-12 border-2 border-dashed rounded-lg text-center cursor-pointer transition-colors border-slate-300 bg-slate-50 hover:border-blue-500">
                                <input type="file" id="file-input" class="hidden" accept=".csv, .xlsx, .xls">
                                <div class="flex flex-col items-center gap-2 text-slate-600">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                                    <p>Drag & drop a file here, or <span class="font-semibold text-blue-600">click to select</span></p>
                                    <p class="text-xs text-slate-500">Supported formats: CSV, XLSX, XLS</p>
                                </div>
                            </div>
                            <div id="upload-error" class="mt-4 text-center lg:text-left text-red-600"></div>
                        </div>
                        <div class="mascot-container">
                             <svg viewBox="0 0 100 250"><use href="#detective-base"/><path d="M50,100 L10,120" fill="none" stroke="#475569" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                    </div>
                </div>

                <!-- Step 1.5: AI Parsing & Mapping -->
                <div id="step-parsing" class="step">
                    <div class="text-center flex flex-col items-center justify-center h-full min-h-[300px]">
                        <svg class="animate-spin h-8 w-8 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <h2 id="parsing-title" class="text-2xl font-semibold text-slate-800">Reading Your Spreadsheet...</h2>
                        <p id="parsing-subtitle" class="text-slate-500 mt-1">Please wait, this may take a moment for large files.</p>
                    </div>
                </div>
                
                <!-- Step 2: Action Choice -->
                <div id="step-action-choice" class="step">
                     <div class="grid grid-cols-1 lg:grid-cols-3">
                        <div class="lg:col-span-2 text-center lg:text-left">
                            <div>
                                <h2 class="text-2xl font-semibold text-slate-800">Step 2: Choose Your Path</h2>
                                <p class="text-slate-500 mt-1">Our AI has analyzed your spreadsheet. How would you like to proceed?</p>
                            </div>
                            <div id="action-choice-error" class="my-4 p-3 text-red-700 bg-red-100 rounded-lg hidden"></div>
                            <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-center lg:justify-start">
                                <button id="prospect-button-init" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors w-full sm:w-auto">Find Me More Friends</button>
                                <button id="verify-button" class="bg-slate-700 text-white font-semibold py-3 px-6 rounded-lg hover:bg-slate-800 transition-colors w-full sm:w-auto">Start Verification</button>
                            </div>
                        </div>
                        <div class="mascot-container">
                             <svg viewBox="0 0 100 250"><use href="#detective-base"/><path d="M50,100 L20,110 M50,100 L80,110" fill="none" stroke="#475569" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                    </div>
                </div>

                <!-- Step 2.5: Prospecting Input -->
                <div id="step-prospect-input" class="step">
                    <div class="grid grid-cols-1 lg:grid-cols-3">
                        <div class="lg:col-span-2">
                            <div>
                                <h2 class="text-2xl font-semibold text-slate-800">Find New Prospects</h2>
                                <p class="text-slate-500 mt-1">What type of businesses are you looking for?</p>
                            </div>
                            <div class="mt-6">
                                <label for="prospect-keyword" class="block text-sm font-medium text-slate-700">Business Type (e.g., "plumbers", "dentists")</label>
                                <input type="text" id="prospect-keyword" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter a business type or keyword">
                            </div>
                            <div id="prospect-input-error" class="mt-2 text-sm text-red-600"></div>
                            <div class="flex justify-end mt-6">
                                <button id="start-prospecting-button" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Search for Prospects</button>
                            </div>
                        </div>
                        <div class="mascot-container">
                            <svg viewBox="0 0 100 250"><use href="#detective-base"/><path d="M50,100 L20,90" fill="none" stroke="#475569" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Processing -->
                <div id="step-processing" class="step">
                     <div class="grid grid-cols-1 lg:grid-cols-3">
                        <div class="lg:col-span-2">
                            <div class="text-center">
                                <h2 id="processing-title" class="text-2xl font-semibold text-slate-800">Processing...</h2>
                                <p id="processing-subtitle" class="text-slate-500 mt-1">Please wait while we process your request.</p>
                            </div>
                             <div class="mt-8 flex flex-col items-center gap-4">
                                <div class="w-full bg-slate-200 rounded-full h-2.5"><div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                                <p id="progress-text" class="text-slate-600"></p>
                            </div>
                        </div>
                        <div class="mascot-container">
                             <svg viewBox="0 0 100 250"><use href="#detective-base"/><path d="M50,100 L30,90" fill="none" stroke="#475569" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="20" cy="85" r="8" stroke="#475569" stroke-width="2"/><line x1="14" y1="79" x2="26" y2="73" stroke="#475569" stroke-width="1.5"/></svg>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Results -->
                <div id="step-results" class="step">
                    <div class="grid grid-cols-1 lg:grid-cols-3">
                        <div class="lg:col-span-2">
                            <div>
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h2 id="results-title" class="text-2xl font-semibold text-slate-800">Results</h2>
                                        <p id="results-subtitle" class="text-slate-500 mt-1">Review the data and make changes as needed.</p>
                                    </div>
                                     <div class="flex gap-2">
                                        <button id="restart-button" class="border border-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-100 transition-colors">Start Over</button>
                                        <button id="export-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Export to Excel</button>
                                    </div>
                                </div>
                            </div>
                            <div id="results-table-container" class="mt-6 rounded-lg border"></div>
                        </div>
                        <div class="mascot-container">
                             <svg viewBox="0 0 100 250"><use href="#detective-base"/><path d="M40,55 q5,5 10,0 q5,-5 10,0" fill="none" stroke="#475569" stroke-width="1.5"/><path d="M50,100 L60,120 M50,100 L40,120" fill="none" stroke="#475569" stroke-width="2"/></svg>
                        </div>
                    </div>
                </div>
            </main>
             <footer class="text-center mt-8">
                <p class="text-sm text-slate-500">Secure & Reliable Verification Tool</p>
            </footer>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        state: {
            fileData: [],
            aiMapping: {},
            mappedData: [],
            resultsData: [],
            secureProxyUrl: "/.netlify/functions",
        },
        elements: {},

        init() { this.cacheElements(); this.bindEvents(); },

        cacheElements() {
            const ids = ['dropzone', 'file-input', 'upload-error', 'parsing-title', 'parsing-subtitle', 'action-choice-error', 'verify-button', 'prospect-button-init', 'start-prospecting-button', 'prospect-keyword', 'prospect-input-error', 'progress-bar', 'progress-text', 'processing-title', 'processing-subtitle', 'results-table-container', 'results-title', 'results-subtitle', 'export-button', 'restart-button'];
            ids.forEach(id => this.elements[id.replace(/-/g, '')] = document.getElementById(id));
            this.elements.steps = {
                upload: document.getElementById('step-upload'),
                parsing: document.getElementById('step-parsing'),
                actionchoice: document.getElementById('step-action-choice'),
                prospectinput: document.getElementById('step-prospect-input'),
                processing: document.getElementById('step-processing'),
                results: document.getElementById('step-results'),
            };
        },

        navigateTo(step) { Object.values(this.elements.steps).forEach(s => s.classList.remove('active')); this.elements.steps[step]?.classList.add('active'); },

        bindEvents() {
            const { dropzone, fileinput, verifybutton, prospectbuttoninit, startprospectingbutton, exportbutton, restartbutton } = this.elements;
            dropzone.addEventListener('click', () => fileinput.click());
            dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('border-blue-500'); });
            dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-blue-500'));
            dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('border-blue-500'); this.handleFile(e.dataTransfer.files[0]); });
            fileinput.addEventListener('change', e => this.handleFile(e.target.files[0]));
            verifybutton.addEventListener('click', () => this.runVerification());
            prospectbuttoninit.addEventListener('click', () => this.navigateTo('prospectinput'));
            startprospectingbutton.addEventListener('click', () => this.handleProspectSearch());
            exportbutton.addEventListener('click', () => this.exportResults());
            restartbutton.addEventListener('click', () => this.restart());
        },

        handleFile(file) {
            if (!file) return;
            this.showError('upload', ''); this.navigateTo('parsing');
            setTimeout(() => {
                const ext = file.name.split('.').pop().toLowerCase();
                if (ext === 'csv') this.parseCsv(file);
                else if (['xlsx', 'xls'].includes(ext)) this.parseExcel(file);
                else { this.showError('upload', 'Unsupported file type.'); this.navigateTo('upload'); }
            }, 100);
        },

        parseCsv(file) { Papa.parse(file, { header: true, skipEmptyLines: true, preview: 5, complete: res => this.onFileParsed(res.meta.fields, res.data), error: err => { this.showError('upload', `CSV Error: ${err.message}`); this.navigateTo('upload'); } }); },
        
        parseExcel(file) {
            const reader = new FileReader();
            reader.onload = async e => {
                try {
                    const workbook = new ExcelJS.Workbook(); await workbook.xlsx.load(e.target.result);
                    const worksheet = workbook.worksheets[0]; let headerRowNumber = -1, headers = [];
                    worksheet.eachRow((row, rowNum) => { if (row.values.filter(Boolean).length > 0 && headerRowNumber < 0) { headers = row.values.filter(Boolean).map(h => h.toString().trim()); headerRowNumber = rowNum; } });
                    if (headers.length === 0) throw new Error("Could not find a valid header row.");
                    const data = [];
                    worksheet.eachRow((row, rowNumber) => {
                        if (rowNumber > headerRowNumber && data.length < 5) { // Only read first 5 data rows for mapping
                            const rowData = {}; let hasData = false;
                            row.eachCell({ includeEmpty: true }, (cell, colNumber) => { const header = headers[colNumber - 1]; if (header) { let val = cell.value?.toString() || ''; rowData[header] = val; if(val) hasData = true; } });
                            if (hasData) data.push(rowData);
                        }
                    });
                    this.onFileParsed(headers, data);
                } catch (err) { this.showError('upload', `Excel Error: ${err.message}`); this.navigateTo('upload'); }
            };
            reader.readAsArrayBuffer(file);
        },

        async onFileParsed(headers, sampleData) {
            this.elements.parsingtitle.textContent = "AI Analyzing Columns...";
            this.elements.parsingsubtitle.textContent = "Our detective is figuring out your spreadsheet structure.";
            try {
                const { mapping } = await this.callSecureFunction('intelligent-mapper', { headers, sampleData });
                this.state.aiMapping = mapping;
                this.mapDataWithAI(); // Remap the full dataset
                this.navigateTo('actionchoice');
            } catch (error) {
                this.showError('upload', `AI Mapping Failed: ${error.message}. Please check file format.`);
                this.navigateTo('upload');
            }
        },

        mapDataWithAI() {
            const { aiMapping, fileData } = this.state;
            const mappedFields = Object.values(aiMapping);
            this.state.mappedData = this.state.fileData.map(row => {
                const newRow = {};
                mappedFields.forEach(field => {
                    const header = Object.keys(aiMapping).find(h => aiMapping[h] === field);
                    newRow[field] = row[header] || '';
                });
                return newRow;
            });
        },
        
        handleProspectSearch() {
            const keyword = this.elements.prospectkeyword.value.trim();
            this.elements.prospectinputerror.textContent = '';
            if (!keyword) { this.elements.prospectinputerror.textContent = 'Please enter a business type to search for.'; return; }
            this.runProspecting(keyword);
        },

        async callSecureFunction(endpoint, payload) {
            const response = await fetch(`${this.state.secureProxyUrl}/${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { const err = await response.json(); throw new Error(err.error || 'A server error occurred.'); }
            return response.json();
        },

        async runVerification() {
            if (this.state.fileData.length > 0 && this.state.mappedData.length === 0) this.mapDataWithAI(); // Ensure data is mapped if coming from a reload
            this.elements.processingtitle.textContent = "Verifying Businesses..."; this.elements.processingsubtitle.textContent = "Please wait while we check your records with the Google Places API.";
            this.navigateTo('processing'); this.state.resultsData = []; const total = this.state.mappedData.length;
            for (let i = 0; i < total; i++) {
                const item = this.state.mappedData[i];
                try { const result = await this.callSecureFunction('verify-place', { business: item }); this.state.resultsData.push(result); } catch (error) { this.state.resultsData.push({ ...item, Status: 'API Error', 'Current Occupant': error.message, 'Verification Link': '#' }); }
                const progress = ((i + 1) / total) * 100; this.elements.progressbar.style.width = `${progress}%`; this.elements.progresstext.textContent = `Verifying: ${item['Business Name']} (${i + 1} of ${total})`;
            }
            this.renderVerificationResults(); this.navigateTo('results');
        },

        async runProspecting(keyword) {
             if (this.state.fileData.length > 0 && this.state.mappedData.length === 0) this.mapDataWithAI();
            this.elements.processingtitle.textContent = "Finding New Friends..."; this.elements.processingsubtitle.textContent = `Searching for '${keyword}' in your provided zip codes.`;
            this.elements.progresstext.textContent = "Sending request to our secure prospecting service...";
            this.navigateTo('processing');
            try {
                const result = await this.callSecureFunction('find-prospects', { businesses: this.state.mappedData, keyword: keyword });
                this.state.resultsData = result.prospects;
                this.renderProspectingResults(); this.navigateTo('results');
            } catch (error) { this.showError('prospectinput', `Prospecting failed: ${error.message}`); this.navigateTo('prospectinput'); }
        },
        
        renderVerificationResults() {
            this.elements.resultstitle.textContent = "Verification Results"; this.elements.resultssubtitle.textContent = "The 'Status' column is editable. Click to make changes.";
            const headers = ['Business Name', 'Address', 'Status', 'Current Occupant', 'Verification Link'];
            const headerHtml = headers.map(h => `<th class="p-3 text-left font-semibold text-slate-700">${h}</th>`).join('');
            const rowsHtml = this.state.resultsData.map((res, index) => {
                const status = res['Status'] || 'Not Found';
                const colors = { 'Verified': 'bg-green-100 text-green-800', 'Not Found': 'bg-red-100 text-red-800', 'API Error': 'bg-yellow-100 text-yellow-800' };
                const cells = `<td class="p-3 font-medium">${res['Business Name'] || ''}</td> <td class="p-3">${res['Address'] || ''}</td> <td class="p-3 status-cell" contenteditable="true" data-row-index="${index}"><span class="px-2 py-1 rounded-full text-xs font-medium ${colors[status] || 'bg-slate-100'}">${status}</span></td> <td class="p-3">${res['Current Occupant'] || 'N/A'}</td> <td class="p-3"><a href="${res['Verification Link']}" target="_blank" class="text-blue-600 hover:underline">Search</a></td>`;
                return `<tr class="border-t">${cells}</tr>`;
            }).join('');
            this.elements.resultstablecontainer.innerHTML = `<table class="w-full text-sm"><thead class="bg-slate-50"><tr>${headerHtml}</tr></thead><tbody>${rowsHtml}</tbody></table>`;
        },

        renderProspectingResults() {
            this.elements.resultstitle.textContent = "New Prospects Found"; this.elements.resultssubtitle.textContent = "Here are new businesses we found based on your list.";
            const headers = ['Business Name', 'Address', 'Phone Number', 'Quick Search'];
            const headerHtml = headers.map(h => `<th class="p-3 text-left font-semibold text-slate-700">${h}</th>`).join('');
            const rowsHtml = this.state.resultsData.map(res => {
                const searchQuery = `https://www.google.com/search?q=${encodeURIComponent(res['Business Name'] + ' ' + res['Address'])}`;
                const cells = `<td class="p-3 font-medium">${res['Business Name'] || ''}</td> <td class="p-3">${res['Address'] || ''}</td> <td class="p-3">${res['Phone Number'] || 'N/A'}</td> <td class="p-3"><a href="${searchQuery}" target="_blank" class="text-blue-600 hover:underline">Search</a></td>`;
                return `<tr class="border-t">${cells}</tr>`;
            }).join('');
            this.elements.resultstablecontainer.innerHTML = `<table class="w-full text-sm"><thead class="bg-slate-50"><tr>${headerHtml}</tr></thead><tbody>${rowsHtml}</tbody></table>`;
        },
        
        async exportResults() {
            if (document.querySelector('.status-cell')) { document.querySelectorAll('.status-cell').forEach(cell => { const index = parseInt(cell.dataset.rowIndex, 10); if (this.state.resultsData[index]) this.state.resultsData[index]['Status'] = cell.textContent; }); }
            if (!this.state.resultsData.length) return;
            const workbook = new ExcelJS.Workbook(); const worksheet = workbook.addWorksheet('Results');
            worksheet.columns = Object.keys(this.state.resultsData[0]).map(h => ({ header: h, key: h, width: h.toLowerCase().includes('address') ? 40 : 25 }));
            this.state.resultsData.forEach(row => worksheet.addRow(row));
            const buffer = await workbook.xlsx.writeBuffer(); saveAs(new Blob([buffer]), 'verification_results.xlsx');
        },

        restart() {
            this.state = { fileData: [], aiMapping: {}, mappedData: [], resultsData: [], secureProxyUrl: "/.netlify/functions" };
            this.elements.fileinput.value = ''; this.navigateTo('upload');
        },
        
        showError(step, message) { const el = this.elements[`${step}Error`]; if (el) { el.textContent = message; el.classList.toggle('hidden', !message); } }
    };

    App.init();
});
</script>
</body>
</html>

