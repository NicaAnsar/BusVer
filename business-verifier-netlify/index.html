<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Verification Assistant - v17.0 Netlify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .step { display: none; }
        .step.active { display: block; }
        [contenteditable]:focus { outline: 2px solid #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-5xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold tracking-tight text-slate-800">Business Verification Assistant</h1>
                <p class="text-slate-600 mt-2">Secure, automated verification powered by Google Places.</p>
            </header>

            <main id="app-container" class="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-slate-200 min-h-[400px]">
                <!-- Step 1: File Upload -->
                <div id="step-upload" class="step active">
                    <div class="text-center">
                        <h2 class="text-2xl font-semibold text-slate-800">Step 1: Upload File</h2>
                        <p class="text-slate-500 mt-1">Select or drag a CSV or Excel file to get started.</p>
                    </div>
                    <div id="dropzone" class="mt-8 p-12 border-2 border-dashed rounded-lg text-center cursor-pointer transition-colors border-slate-300 bg-slate-50 hover:border-blue-500">
                        <input type="file" id="file-input" class="hidden" accept=".csv, .xlsx, .xls">
                        <div class="flex flex-col items-center gap-2 text-slate-600">
                             <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                            <p>Drag & drop a file here, or <span class="font-semibold text-blue-600">click to select</span></p>
                            <p class="text-xs text-slate-500">Supported formats: CSV, XLSX, XLS</p>
                        </div>
                    </div>
                    <div id="upload-error" class="mt-4 text-center text-red-600"></div>
                </div>

                <!-- Step 2: Column Mapping -->
                <div id="step-mapping" class="step">
                     <div>
                        <h2 class="text-2xl font-semibold text-slate-800">Step 2: Map Columns</h2>
                        <p class="text-slate-500 mt-1">Match your file's columns to the required data fields to begin.</p>
                    </div>
                    <div id="mapping-error" class="my-4 p-3 text-red-700 bg-red-100 rounded-lg hidden"></div>
                    <div id="mapping-table-container" class="mt-6 rounded-lg border"></div>
                    <div class="flex justify-end mt-6">
                        <button id="map-button" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Start Verification</button>
                    </div>
                </div>
                
                <!-- Step 3: Processing -->
                <div id="step-processing" class="step">
                    <div class="text-center">
                        <h2 class="text-2xl font-semibold text-slate-800">Processing...</h2>
                        <p class="text-slate-500 mt-1">Please wait while we securely verify your records. This may take a moment.</p>
                    </div>
                     <div class="mt-8 flex flex-col items-center gap-4">
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="progress-text" class="text-slate-600"></p>
                    </div>
                </div>

                <!-- Step 4: Results -->
                <div id="step-results" class="step">
                    <div>
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-semibold text-slate-800">Step 4: Verify & Export</h2>
                                <p class="text-slate-500 mt-1">Review the automated results and make manual corrections as needed.</p>
                            </div>
                             <div class="flex gap-2">
                                <button id="restart-button" class="border border-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-100 transition-colors">Start Over</button>
                                <button id="export-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Export to Excel</button>
                            </div>
                        </div>
                    </div>
                    <div id="results-table-container" class="mt-6 rounded-lg border"></div>
                </div>
            </main>
             <footer class="text-center mt-8">
                <p class="text-sm text-slate-500">v17.0 Netlify - Secure & Reliable.</p>
            </footer>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        state: { fileHeaders: [], fileData: [], resultsData: [] },
        elements: {},
        secureProxyUrl: "/.netlify/functions/verify-place",

        init() {
            this.cacheElements();
            this.bindEvents();
        },

        cacheElements() {
            const ids = ['dropzone', 'file-input', 'upload-error', 'mapping-error', 'mapping-table-container', 'map-button', 'progress-bar', 'progress-text', 'results-table-container', 'export-button', 'restart-button'];
            ids.forEach(id => this.elements[id.replace(/-/g, '')] = document.getElementById(id));
            this.elements.steps = {
                upload: document.getElementById('step-upload'),
                mapping: document.getElementById('step-mapping'),
                processing: document.getElementById('step-processing'),
                results: document.getElementById('step-results'),
            };
        },

        navigateTo(step) {
            Object.values(this.elements.steps).forEach(s => s.classList.remove('active'));
            this.elements.steps[step]?.classList.add('active');
        },

        bindEvents() {
            const { dropzone, fileinput, mapbutton, exportbutton, restartbutton } = this.elements;
            dropzone.addEventListener('click', () => fileinput.click());
            dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('border-blue-500'); });
            dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-blue-500'));
            dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('border-blue-500'); this.handleFile(e.dataTransfer.files[0]); });
            fileinput.addEventListener('change', e => this.handleFile(e.target.files[0]));
            mapbutton.addEventListener('click', () => this.processMapping());
            exportbutton.addEventListener('click', () => this.exportResults());
            restartbutton.addEventListener('click', () => this.restart());
        },

        handleFile(file) {
            if (!file) return;
            this.showError('upload', '');
            const ext = file.name.split('.').pop().toLowerCase();
            if (ext === 'csv') this.parseCsv(file);
            else if (['xlsx', 'xls'].includes(ext)) this.parseExcel(file);
            else this.showError('upload', 'Unsupported file type.');
        },

        parseCsv(file) { Papa.parse(file, { header: true, skipEmptyLines: true, complete: res => this.onFileParsed(res.meta.fields, res.data), error: err => this.showError('upload', `CSV Error: ${err.message}`) }); },
        
        parseExcel(file) {
            const reader = new FileReader();
            reader.onload = async e => {
                try {
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(e.target.result);
                    const worksheet = workbook.worksheets[0];
                    const headers = (worksheet.getRow(1).values || []).filter(Boolean).map(h => h.toString());
                    const data = [];
                    worksheet.eachRow((row, rowNumber) => {
                        if (rowNumber > 1) {
                            const rowData = {};
                            row.eachCell({ includeEmpty: true }, (cell, colNumber) => { if (headers[colNumber - 1]) rowData[headers[colNumber - 1]] = cell.value?.toString() || ''; });
                            data.push(rowData);
                        }
                    });
                    this.onFileParsed(headers, data);
                } catch (err) { this.showError('upload', `Excel Error: ${err.message}`); }
            };
            reader.readAsArrayBuffer(file);
        },

        onFileParsed(headers, data) {
            this.state.fileHeaders = headers;
            this.state.fileData = data;
            this.renderMappingTable();
            this.navigateTo('mapping');
        },

        renderMappingTable() {
            const TARGET_FIELDS = ['Business Name', 'Address', 'Phone', 'Email'];
            const autoDetect = h => { const l = (h || '').toLowerCase(); if (l.includes('name')) return 'Business Name'; if (l.includes('address')) return 'Address'; return ''; };
            let tableHtml = `<table class="w-full text-sm"><thead class="bg-slate-50"><tr><th class="p-3 text-left font-semibold">Your Column</th><th class="p-3 text-left font-semibold">Map to Field</th></tr></thead><tbody>`;
            const detected = {};
            this.state.fileHeaders.forEach(h => { const d = autoDetect(h); if (d && !Object.values(detected).includes(d)) detected[h] = d; });
            this.state.fileHeaders.forEach(h => {
                const sel = detected[h] || '';
                let opts = '<option value="ignore">Ignore</option>';
                TARGET_FIELDS.forEach(f => opts += `<option value="${f}" ${sel === f ? 'selected' : ''}>${f}</option>`);
                tableHtml += `<tr class="border-t"><td class="p-3 font-medium">${h}</td><td class="p-3"><select data-header="${h}" class="mapping-select w-full p-2 border rounded-md bg-white">${opts}</select></td></tr>`;
            });
            this.elements.mappingtablecontainer.innerHTML = tableHtml + '</tbody></table>';
        },

        processMapping() {
            this.showError('mapping', '');
            const mappings = {};
            const fields = new Set();
            document.querySelectorAll('.mapping-select').forEach(s => {
                if (s.value !== 'ignore') {
                    if (fields.has(s.value)) return this.showError('mapping', `Field '${s.value}' mapped multiple times.`);
                    mappings[s.dataset.header] = s.value;
                    fields.add(s.value);
                }
            });
            if (this.elements.mappingerror.textContent) return;

            const mappedData = this.state.fileData.map(row => {
                const newRow = {};
                fields.forEach(field => { const header = Object.keys(mappings).find(h => mappings[h] === field); newRow[field] = row[header] || ''; });
                return newRow;
            });
            
            this.runAutomatedVerification(mappedData);
        },
        
        async verifyWithGooglePlaces(item) {
            const name = item['Business Name'];
            const address = item['Address'];
            if (!name) return { status: 'Uncertain', foundName: '' };
            
            try {
                const response = await fetch(this.secureProxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, address })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Proxy Error:", response.statusText, errorText);
                    this.showError('mapping', `Verification service error: ${response.statusText}`);
                    return { status: 'API Error', foundName: '' };
                }

                const data = await response.json();
                
                if (data.status === 'OK' && data.candidates && data.candidates.length > 0) {
                    const foundName = data.candidates[0].name || '';
                    return { status: 'Verified', foundName: foundName };
                } else if (data.error_message) {
                    console.error('Google Places API Error:', data.error_message);
                    this.showError('mapping', `Google API Error: ${data.error_message}.`);
                    return { status: 'API Error', foundName: '' };
                }
                else {
                     return { status: 'Not Found', foundName: '' };
                }
            } catch (error) {
                console.error('API call failed:', error);
                this.showError('mapping', 'Could not connect to the verification service. Ensure deployment is correct.');
                return { status: 'API Error', foundName: '' };
            }
        },

        async runAutomatedVerification(data) {
            this.navigateTo('processing');
            this.state.resultsData = [];
            const total = data.length;

            for (let i = 0; i < total; i++) {
                if (this.elements.mappingerror.textContent) break;

                const item = data[i];
                const result = await this.verifyWithGooglePlaces(item);

                const searchQuery = `${item['Business Name'] || ''} ${item['Address'] || ''}`;
                this.state.resultsData.push({ 
                    ...item, 
                    'Status': result.status,
                    'Current Occupant': result.foundName,
                    'Verification Link': `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}`
                });

                const progress = ((i + 1) / total) * 100;
                this.elements.progressbar.style.width = `${progress}%`;
                this.elements.progresstext.textContent = `Verifying: ${item['Business Name']} (${i + 1} of ${total})`;
                await new Promise(r => setTimeout(r, 50));
            }
            
            if (this.elements.mappingerror.textContent) {
                this.navigateTo('mapping');
            } else {
                this.renderResultsTable();
                this.navigateTo('results');
            }
        },

        renderResultsTable() {
            const results = this.state.resultsData;
            if (!results.length) {
                this.elements.resultstablecontainer.innerHTML = `<p class="p-4 text-center text-slate-500">No results to display.</p>`;
                return;
            }
            
            const availableHeaders = Object.keys(results[0]);
            const desiredOrder = [ 'Business Name', 'Address', 'Phone', 'Email', 'Status', 'Current Occupant', 'Verification Link' ];
            const headers = desiredOrder.filter(h => availableHeaders.includes(h));
            
            const headerHtml = headers.map(h => `<th class="p-3 text-left font-semibold text-slate-700">${h}</th>`).join('');
            
            const rowsHtml = results.map((res, index) => {
                const cells = headers.map(h => {
                    const val = res[h] || '';
                    if (h === 'Verification Link') return `<td class="p-3"><a href="${val}" target="_blank" class="text-blue-600 hover:underline">Search</a></td>`;
                    if (h === 'Status') {
                        const colors = { 'Verified': 'bg-green-100 text-green-800', 'Not Found': 'bg-red-100 text-red-800', 'Uncertain': 'bg-yellow-100 text-yellow-800', 'API Error': 'bg-orange-100 text-orange-800' };
                        const statusHtml = `<span class="px-2 py-1 rounded-full text-xs font-medium ${colors[val] || 'bg-slate-100'}">${val}</span>`;
                        return `<td class="p-3 status-cell" contenteditable="true" data-row-index="${index}">${statusHtml}</td>`;
                    }
                    return `<td class="p-3 font-medium">${val}</td>`;
                }).join('');
                return `<tr class="border-t">${cells}</tr>`;
            }).join('');

            this.elements.resultstablecontainer.innerHTML = `<table class="w-full text-sm"><thead class="bg-slate-50"><tr>${headerHtml}</tr></thead><tbody>${rowsHtml}</tbody></table>`;
        },

        async exportResults() {
            document.querySelectorAll('.status-cell').forEach(cell => {
                const index = parseInt(cell.dataset.rowIndex, 10);
                if (this.state.resultsData[index]) this.state.resultsData[index]['Status'] = cell.textContent.trim();
            });

            if (!this.state.resultsData.length) return;
            
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Results');
            worksheet.columns = Object.keys(this.state.resultsData[0]).map(h => ({ header: h, key: h, width: h.toLowerCase().includes('address') ? 40 : 25 }));
            this.state.resultsData.forEach(row => worksheet.addRow(row));
            
            const buffer = await workbook.xlsx.writeBuffer();
            saveAs(new Blob([buffer]), 'verification_results.xlsx');
        },

        restart() {
            this.state = { fileHeaders: [], fileData: [], resultsData: [] };
            this.elements.fileinput.value = '';
            this.navigateTo('upload');
        },
        
        showError(step, message) {
            const el = this.elements[`${step}Error`];
            if (el) { el.textContent = message; el.classList.toggle('hidden', !message); }
        }
    };
    App.init(); 
});
</script>
</body>
</html>


