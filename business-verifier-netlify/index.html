<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Verification & Prospecting Tool - v18.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .step { display: none; }
        .step.active { display: block; }
        [contenteditable]:focus { outline: 2px solid #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-5xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold tracking-tight text-slate-800">Business Verification & Prospecting</h1>
                <p class="text-slate-600 mt-2">Verify your list or find new leads in the same area.</p>
            </header>

            <main id="app-container" class="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-slate-200 min-h-[400px]">
                <!-- Step 1: File Upload -->
                <div id="step-upload" class="step active">
                    <div class="text-center">
                        <h2 class="text-2xl font-semibold text-slate-800">Step 1: Upload File</h2>
                        <p class="text-slate-500 mt-1">Upload your current customer or lead list to get started.</p>
                    </div>
                    <div id="dropzone" class="mt-8 p-12 border-2 border-dashed rounded-lg text-center cursor-pointer transition-colors border-slate-300 bg-slate-50 hover:border-blue-500">
                        <input type="file" id="file-input" class="hidden" accept=".csv, .xlsx, .xls">
                        <div class="flex flex-col items-center gap-2 text-slate-600">
                             <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                            <p>Drag & drop a file here, or <span class="font-semibold text-blue-600">click to select</span></p>
                            <p class="text-xs text-slate-500">Supported formats: CSV, XLSX, XLS</p>
                        </div>
                    </div>
                    <div id="upload-error" class="mt-4 text-center text-red-600"></div>
                </div>

                <!-- Step 2: Column Mapping -->
                <div id="step-mapping" class="step">
                     <div>
                        <h2 class="text-2xl font-semibold text-slate-800">Step 2: Map Columns & Choose Action</h2>
                        <p class="text-slate-500 mt-1">Map your columns, then choose to verify your list or find new prospects.</p>
                    </div>
                    <div id="mapping-error" class="my-4 p-3 text-red-700 bg-red-100 rounded-lg hidden"></div>
                    <div id="mapping-table-container" class="mt-6 rounded-lg border"></div>
                    <div class="flex justify-end mt-6 space-x-4">
                        <button id="prospect-button" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Find Me More Friends</button>
                        <button id="map-button" class="bg-blue-800 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-900 transition-colors">Start Verification</button>
                    </div>
                </div>
                
                <!-- Step 3: Processing -->
                <div id="step-processing" class="step">
                    <div class="text-center">
                        <h2 id="processing-title" class="text-2xl font-semibold text-slate-800">Processing...</h2>
                        <p id="processing-subtitle" class="text-slate-500 mt-1">Please wait while we process your request.</p>
                    </div>
                     <div class="mt-8 flex flex-col items-center gap-4">
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="progress-text" class="text-slate-600"></p>
                    </div>
                </div>

                <!-- Step 4: Results -->
                <div id="step-results" class="step">
                    <div>
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 id="results-title" class="text-2xl font-semibold text-slate-800">Results</h2>
                                <p id="results-subtitle" class="text-slate-500 mt-1">Review your results below.</p>
                            </div>
                             <div class="flex gap-2">
                                <button id="restart-button" class="border border-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-100 transition-colors">Start Over</button>
                                <button id="export-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Export to Excel</button>
                            </div>
                        </div>
                    </div>
                    <div id="results-table-container" class="mt-6 rounded-lg border"></div>
                </div>
            </main>
             <footer class="text-center mt-8">
                <p class="text-sm text-slate-500">v18.0 - Verification & Prospecting</p>
            </footer>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        state: { fileHeaders: [], fileData: [], resultsData: [], currentAction: 'verify' },
        elements: {},
        
        init() {
            this.cacheElements();
            this.bindEvents();
        },

        cacheElements() {
            const ids = ['dropzone', 'file-input', 'upload-error', 'mapping-error', 'mapping-table-container', 'map-button', 'prospect-button', 'progress-bar', 'progress-text', 'results-table-container', 'export-button', 'restart-button', 'processing-title', 'processing-subtitle', 'results-title', 'results-subtitle'];
            ids.forEach(id => this.elements[id.replace(/-/g, '')] = document.getElementById(id));
            this.elements.steps = {
                upload: document.getElementById('step-upload'),
                mapping: document.getElementById('step-mapping'),
                processing: document.getElementById('step-processing'),
                results: document.getElementById('step-results'),
            };
        },

        navigateTo(step) {
            Object.values(this.elements.steps).forEach(s => s.classList.remove('active'));
            this.elements.steps[step]?.classList.add('active');
        },

        bindEvents() {
            const { dropzone, fileinput, mapbutton, prospectbutton, exportbutton, restartbutton } = this.elements;
            dropzone.addEventListener('click', () => fileinput.click());
            dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('border-blue-500'); });
            dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-blue-500'));
            dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('border-blue-500'); this.handleFile(e.dataTransfer.files[0]); });
            fileinput.addEventListener('change', e => this.handleFile(e.target.files[0]));
            mapbutton.addEventListener('click', () => this.processMapping('verify'));
            prospectbutton.addEventListener('click', () => this.processMapping('prospect'));
            exportbutton.addEventListener('click', () => this.exportResults());
            restartbutton.addEventListener('click', () => this.restart());
        },

        handleFile(file) { if (!file) return; this.showError('upload', ''); const ext = file.name.split('.').pop().toLowerCase(); if (ext === 'csv') this.parseCsv(file); else if (['xlsx', 'xls'].includes(ext)) this.parseExcel(file); else this.showError('upload', 'Unsupported file type.'); },
        parseCsv(file) { Papa.parse(file, { header: true, skipEmptyLines: true, complete: res => this.onFileParsed(res.meta.fields, res.data), error: err => this.showError('upload', `CSV Error: ${err.message}`) }); },
        parseExcel(file) { const reader = new FileReader(); reader.onload = async e => { try { const wb = new ExcelJS.Workbook(); await wb.xlsx.load(e.target.result); const ws = wb.worksheets[0]; const h = (ws.getRow(1).values || []).filter(Boolean).map(x=>x.toString()); const d = []; ws.eachRow((r, n) => { if (n > 1) { const rd = {}; r.eachCell({ includeEmpty: true }, (c, i) => { if (h[i - 1]) rd[h[i - 1]] = c.value?.toString() || ''; }); d.push(rd); } }); this.onFileParsed(h, d); } catch (err) { this.showError('upload', `Excel Error: ${err.message}`); } }; reader.readAsArrayBuffer(file); },

        onFileParsed(headers, data) { this.state.fileHeaders = headers; this.state.fileData = data; this.renderMappingTable(); this.navigateTo('mapping'); },

        renderMappingTable() { const TARGET_FIELDS = ['Business Name', 'Address', 'Phone', 'Email']; const autoDetect = h => { const l = (h || '').toLowerCase(); if (l.includes('name')) return 'Business Name'; if (l.includes('address')) return 'Address'; return ''; }; let t = `<table class="w-full text-sm"><thead class="bg-slate-50"><tr><th class="p-3 text-left font-semibold">Your Column</th><th class="p-3 text-left font-semibold">Map to Field</th></tr></thead><tbody>`; const d = {}; this.state.fileHeaders.forEach(h => { const a = autoDetect(h); if (a && !Object.values(d).includes(a)) d[h] = a; }); this.state.fileHeaders.forEach(h => { const s = d[h] || ''; let o = '<option value="ignore">Ignore</option>'; TARGET_FIELDS.forEach(f => o += `<option value="${f}" ${s === f ? 'selected' : ''}>${f}</option>`); t += `<tr class="border-t"><td class="p-3 font-medium">${h}</td><td class="p-3"><select data-header="${h}" class="mapping-select w-full p-2 border rounded-md bg-white">${o}</select></td></tr>`; }); this.elements.mappingtablecontainer.innerHTML = t + '</tbody></table>'; },

        processMapping(action) {
            this.state.currentAction = action;
            this.showError('mapping', '');
            const mappings = {}; const fields = new Set();
            document.querySelectorAll('.mapping-select').forEach(s => { if (s.value !== 'ignore') { if (fields.has(s.value)) return this.showError('mapping', `Field '${s.value}' mapped multiple times.`); mappings[s.dataset.header] = s.value; fields.add(s.value); } });
            if (this.elements.mappingerror.textContent) return;

            const mappedData = this.state.fileData.map(row => { const newRow = {}; fields.forEach(field => { const header = Object.keys(mappings).find(h => mappings[h] === field); newRow[field] = row[header] || ''; }); return newRow; });
            
            if (action === 'verify') this.runAutomatedVerification(mappedData);
            if (action === 'prospect') this.runProspecting(mappedData);
        },

        async runAutomatedVerification(data) {
            this.elements.processingtitle.textContent = 'Verifying Businesses...';
            this.elements.processingsubtitle.textContent = 'Please wait while we securely verify your records.';
            this.navigateTo('processing');
            this.state.resultsData = [];
            for (let i = 0; i < data.length; i++) {
                if (this.elements.mappingerror.textContent) break;
                const item = data[i];
                const result = await this.callSecureFunction('/.netlify/functions/verify-place', { name: item['Business Name'], address: item['Address'] });
                const { status = 'API Error', foundName = '' } = result || {};
                const searchQuery = `${item['Business Name'] || ''} ${item['Address'] || ''}`;
                this.state.resultsData.push({ ...item, 'Status': status, 'Current Occupant': foundName, 'Verification Link': `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}` });
                this.updateProgress(i + 1, data.length, `Verifying: ${item['Business Name']}`);
            }
            if (!this.elements.mappingerror.textContent) {
                this.elements.resultstitle.textContent = 'Verification Results';
                this.elements.resultssubtitle.textContent = 'Review the automated results and make manual corrections as needed.';
                this.renderResultsTable();
                this.navigateTo('results');
            }
        },
        
        async runProspecting(data) {
            if (!data.some(row => row['Address'])) return this.showError('mapping', 'Address column must be mapped to find prospects.');
            this.elements.processingtitle.textContent = 'Finding New Friends...';
            this.elements.processingsubtitle.textContent = 'Analyzing zip codes and searching for new prospects.';
            this.navigateTo('processing');
            const zipRegex = /\b\d{5}\b/;
            const uniqueZips = [...new Set(data.map(row => (row['Address'] || '').match(zipRegex)?.[0]).filter(Boolean))];
            const existingNames = new Set(data.map(row => (row['Business Name'] || '').toLowerCase()));
            const result = await this.callSecureFunction('/.netlify/functions/find-prospects', { zipCodes: uniqueZips, existingNames: Array.from(existingNames) });
            this.state.resultsData = result?.prospects || [];
            if (!this.elements.mappingerror.textContent) {
                this.elements.resultstitle.textContent = 'New Prospects Found';
                this.elements.resultssubtitle.textContent = `We found ${this.state.resultsData.length} new businesses in or near the zip codes from your list.`;
                this.renderResultsTable();
                this.navigateTo('results');
            }
        },

        async callSecureFunction(endpoint, body) {
            try {
                const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (!response.ok) {
                    const errorData = await response.json();
                    this.showError('mapping', `Service error: ${errorData.error || response.statusText}`);
                    return null;
                }
                return await response.json();
            } catch (error) {
                this.showError('mapping', 'Could not connect to the processing service. Please check the function logs on Netlify.');
                return null;
            }
        },

        updateProgress(current, total, text) {
            const progress = (current / total) * 100;
            this.elements.progressbar.style.width = `${progress}%`;
            this.elements.progresstext.textContent = `${text} (${current} of ${total})`;
        },

        renderResultsTable() {
            const results = this.state.resultsData;
            if (!results.length) { this.elements.resultstablecontainer.innerHTML = `<p class="p-4 text-center text-slate-500">No results to display.</p>`; return; }
            const availableHeaders = Object.keys(results[0]);
            const desiredOrder = this.state.currentAction === 'verify'
                ? ['Business Name', 'Address', 'Phone', 'Email', 'Status', 'Current Occupant', 'Verification Link']
                : ['Business Name', 'Address', 'Phone Number'];
            const headers = desiredOrder.filter(h => availableHeaders.includes(h));
            const headerHtml = headers.map(h => `<th class="p-3 text-left font-semibold text-slate-700">${h}</th>`).join('');
            const rowsHtml = results.map((res, index) => {
                const cells = headers.map(h => {
                    const val = res[h] || '';
                    if (h === 'Verification Link') return `<td class="p-3"><a href="${val}" target="_blank" class="text-blue-600 hover:underline">Search</a></td>`;
                    if (h === 'Status') {
                        const colors = { 'Verified': 'bg-green-100 text-green-800', 'Not Found': 'bg-red-100 text-red-800', 'Uncertain': 'bg-yellow-100 text-yellow-800', 'API Error': 'bg-orange-100 text-orange-800' };
                        const statusHtml = `<span class="px-2 py-1 rounded-full text-xs font-medium ${colors[val] || 'bg-slate-100'}">${val}</span>`;
                        return `<td class="p-3 status-cell" contenteditable="true" data-row-index="${index}">${statusHtml}</td>`;
                    }
                    return `<td class="p-3 font-medium">${val}</td>`;
                }).join('');
                return `<tr class="border-t">${cells}</tr>`;
            }).join('');
            this.elements.resultstablecontainer.innerHTML = `<table class="w-full text-sm"><thead class="bg-slate-50"><tr>${headerHtml}</tr></thead><tbody>${rowsHtml}</tbody></table>`;
        },

        async exportResults() {
            if (this.state.currentAction === 'verify') {
                document.querySelectorAll('.status-cell').forEach(cell => { const index = parseInt(cell.dataset.rowIndex, 10); if (this.state.resultsData[index]) this.state.resultsData[index]['Status'] = cell.textContent.trim(); });
            }
            if (!this.state.resultsData.length) return;
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Results');
            worksheet.columns = Object.keys(this.state.resultsData[0]).map(h => ({ header: h, key: h, width: h.toLowerCase().includes('address') ? 40 : 25 }));
            this.state.resultsData.forEach(row => worksheet.addRow(row));
            const buffer = await workbook.xlsx.writeBuffer();
            const filename = this.state.currentAction === 'verify' ? 'verification_results.xlsx' : 'prospect_list.xlsx';
            saveAs(new Blob([buffer]), filename);
        },

        restart() { this.state = { fileHeaders: [], fileData: [], resultsData: [], currentAction: 'verify' }; this.elements.fileinput.value = ''; this.navigateTo('upload'); },
        showError(step, message) { const el = this.elements[`${step}Error`]; if (el) { el.textContent = message; el.classList.toggle('hidden', !message); } }
    };
    App.init(); 
});
</script>
</body>
</html>
